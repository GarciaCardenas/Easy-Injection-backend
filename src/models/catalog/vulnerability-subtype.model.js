const Joi = require('joi');
const mongoose = require('mongoose');
const debug = require('debug')('easyinjection:models:vulnsubtype');
const BaseModel = require('../base/BaseModel');
const { buildObject } = require('../base/ModelHelpers');

const vulnerabilitySubtypeSchema = new mongoose.Schema({
    tipo_id: { 
        type: mongoose.Schema.Types.ObjectId, 
        ref: 'VulnerabilityType', 
        required: true 
    },
    nombre: { 
        type: String, 
        required: true 
    },
    descripcion: { 
        type: String, 
        maxlength: 500 
    }
});

// Índice único compuesto para evitar duplicados
vulnerabilitySubtypeSchema.index({ tipo_id: 1, nombre: 1 }, { unique: true });

const VulnerabilitySubtypeModel = mongoose.models.VulnerabilitySubtype || 
    mongoose.model('VulnerabilitySubtype', vulnerabilitySubtypeSchema);

class VulnerabilitySubtype extends BaseModel {
    #tipo_id;
    #nombre;
    #descripcion;

    constructor(data = {}) {
        super(data);
        const plainData = data && typeof data.toObject === 'function' ? data.toObject() : data;
        
        this.#tipo_id = plainData.tipo_id;
        this.#nombre = plainData.nombre;
        this.#descripcion = plainData.descripcion;
    }

    get tipo_id() { return this.#tipo_id; }
    get nombre() { return this.#nombre; }
    get descripcion() { return this.#descripcion; }

    static createEmpty() {
        return new VulnerabilitySubtype({ 
            tipo_id: null, 
            nombre: '', 
            descripcion: '' 
        });
    }

    static validate(subtype) {
        const schema = Joi.object({
            tipo_id: Joi.string().required(),
            nombre: Joi.string().required(),
            descripcion: Joi.string().max(500).allow('', null)
        });

        return schema.validate(subtype);
    }

    static get Model() {
        return VulnerabilitySubtypeModel;
    }

    static get debug() {
        return debug;
    }

    toObject() {
        return buildObject(this, ['tipo_id', 'nombre', 'descripcion']);
    }

    toDTO() {
        return {
            _id: this._id,
            tipo_id: this.#tipo_id,
            nombre: this.#nombre,
            descripcion: this.#descripcion
        };
    }

    toString() {
        return `[Subtipo] ${this.#nombre}: ${this.#descripcion || 'Sin descripción'}`;
    }
}

function validateVulnerabilitySubtype(subtype) {
    return VulnerabilitySubtype.validate(subtype);
}

exports.VulnerabilitySubtype = VulnerabilitySubtype;
exports.validate = validateVulnerabilitySubtype;
