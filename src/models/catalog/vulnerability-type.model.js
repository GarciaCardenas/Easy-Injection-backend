const Joi = require('joi');
const mongoose = require('mongoose');
const debug = require('debug')('easyinjection:models:vulntype');
const BaseModel = require('../base/BaseModel');
const { buildObject } = require('../base/ModelHelpers');

const vulnerabilityTypeSchema = new mongoose.Schema({
    nombre: { 
        type: String, 
        enum: ['XSS', 'SQLi', 'CSRF', 'XXE', 'SSTI'], 
        required: true, 
        unique: true 
    },
    descripcion: { type: String, maxlength: 255 }
});

const VulnerabilityTypeModel = mongoose.models.VulnerabilityType || mongoose.model('VulnerabilityType', vulnerabilityTypeSchema);

class VulnerabilityType extends BaseModel {
    #nombre;
    #descripcion;

    constructor(data = {}) {
        super(data);
        const plainData = data && typeof data.toObject === 'function' ? data.toObject() : data;
        
        this.#nombre = plainData.nombre;
        this.#descripcion = plainData.descripcion;
    }

    get nombre() { return this.#nombre; }
    get descripcion() { return this.#descripcion; }

    // Métodos de dominio
    getFullName() {
        const fullNames = {
            'XSS': 'Cross-Site Scripting',
            'SQLi': 'SQL Injection',
            'CSRF': 'Cross-Site Request Forgery',
            'XXE': 'XML External Entity',
            'SSTI': 'Server-Side Template Injection'
        };
        return fullNames[this.#nombre] || this.#nombre;
    }

    static createEmpty() {
        return new VulnerabilityType({ nombre: 'XSS', descripcion: '' });
    }

    static validate(type) {
        const schema = Joi.object({
            nombre: Joi.string().valid('XSS', 'SQLi', 'CSRF', 'XXE', 'SSTI').required(),
            descripcion: Joi.string().max(255)
        });

        return schema.validate(type);
    }

    static get Model() {
        return VulnerabilityTypeModel;
    }

    static get debug() {
        return debug;
    }

    toObject() {
        return buildObject(this, ['nombre', 'descripcion']);
    }

    toString() {
        return `[${this.#nombre}] ${this.getFullName()}: ${this.#descripcion || 'Sin descripción'}`;
    }
}

function validateVulnerabilityType(type) {
    return VulnerabilityType.validate(type);
}

exports.VulnerabilityType = VulnerabilityType;
exports.validate = validateVulnerabilityType;
